<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <!-- Load topojson -->
    <script src="https://unpkg.com/topojson-client@3"></script>
    <!-- Load d3 color-legend -->
    <script src="js/d3-legend.js"></script>

    <!-- Load constants -->
    <script src="js/constants.js"></script>
    <!-- Load data cleaning -->
    <script src="js/data-cleaning.js"></script>
    <!-- Load chart utilities -->
    <script src="js/chart-util.js"></script>

    <!-- Load font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  </head>
  <body>
    <style>
    html {
      font-family: "Roboto", Arial, sans-serif;
    }
    tr:nth-child(even) {
      background-color: rgb(255, 255, 255, 0.5);
    }
    tr:nth-child(odd) {
      background-color: rgb(150, 150, 150, 0.5);
    }
    div.tooltip {
      position: absolute;
      text-align: center;
      width: auto;
      height: auto;
      padding: 2px;
      font: 12px;
      /* background: lightsteelblue; */
      border: 0px;
      border-radius: 8px;
      pointer-events: none;

      transform: translate(10px, -15px);
      z-index:950;
    }
    #textual {
      z-index:950;
      background-color: rgb(255, 255, 255, 0.5);
    }
    #search-bar {
      height: 48px;
      border: 3px solid rgba(131, 149, 179, 0.3);
      border-radius: 16px;
      display: flex;
      padding-left: 4px;
      padding-right: 4px;
      justify-content: start;
      box-shadow: 0 12px 20px 0 rgb(131 149 179 / 0%);
      transition: 0.2s ease box-shadow, 0.2s ease border;
      align-items: center;
      background-color: #fff;
      width: 100%;
      box-sizing: border-box;
    }
    #search-bar.outline {
      border: 3px solid rgba(31, 49, 79, 0.7);
    }
    #search-icon {
      width: 20px;
      display: flex;
      align-items: center;
    }
    #search {
      height: 42px;
      padding: 0;
      padding-left: 8px;
      border: 0;
      width: calc(100% - 28px);
      font-size: 16px;
      line-height: 30px;
      letter-spacing: 0.5px;
      font-weight: 300;
      background-color: #fff;
      font-family: inherit;

      outline:none;
    }
    #viz {
      font-family: inherit;

      /* Full height */
      height: 100%;
      background-color: rgb(232, 232, 232);
    }
    #top-similar-countries{
      list-style: none;
      padding: 0 20 0 20;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      font-family: inherit;
    }
    #right-panel {
      z-index:950;
      background-color: rgb(255, 255, 255, 0.5);
    }
    #flag-details {
      width: 100%;
    }
    #mymap {
      max-width:100%;
      max-height:100%;

      /* Center and scale the image nicely */
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }
    #map-legend {
      z-index:950;
      /*background-color: rgb(255, 255, 255, 0.5);*/
    }
    #world {
      z-index:900;
      position:fixed;
      top:50%;
      left:50%;
      height:100%;
      width:100%;
      transform: translate(-50%, -40%);
    }
    </style>

    <div id="viz" style="display: grid; grid-gap: .875rem; grid-template-columns: 300px 1fr 300px;">
      <div id="textual" style="display: inline-flex; flex-direction: column; align-items: start; font: 400 .75rem; color: #1b1e23; width: 100%;">
        <h1>6.859 Flag Similarity</h1>
        <div id="search-bar">
          <div id="search-icon"><svg viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            <path d="M0 0h24v24H0z" fill="none"/>
          </svg></div>
          <input id="search" type="text" placeholder="Enter country here..."></input>
        </div>
        <ol id="top-similar-countries"></ol>
      </div>
      <div id="mymap" style="display: inline-flex; flex-direction: column; align-items: start; font: 400 .75rem; color: #1b1e23; width: 100%;">
        <div id="map-legend" style="float: right; width: 100%;"><div style="float: right; width: 95%">
          <!-- ${chartLegend} -->
        </div></div>
      </div>
      <div id="right-panel" style="display: inline-flex; flex-direction: column; align-items: start; font: 400 .75rem; color: #1b1e23; width: 100%;">
        <table id="flag-details">
          <tr>
            <th>Country</th>
            <th id="detail-top-cell"></th>
          </tr>
        </table>
      </div>
    </div>

<!--     <div id="chart" style="width:520px;height:420px;">
      This is where we will put our chart.
    </div>
    <style>
      .selected {
        opacity: 1 !important;
        stroke: black;
        stroke-width: 1px;
      }
    </style> -->
<!-- 
    <script>


      //*********************************************************************
      // reloads on chartData change
      // color = d3.scaleSequential()
      //     // .domain(d3.extent([0, 20]))
      //     .domain(d3.extent(Array.from(chartData.values())))
      //     .interpolator(d3.interpolateYlGnBu)
      //     .unknown("#ccc")

      // Load data from a URL. You can also have the json file downloaded.
      // See https://github.com/d3/d3/blob/master/API.md#fetches-d3-fetch for more options.
      d3.json("https://cdn.jsdelivr.net/npm/vega-datasets@2.2.0/data/gapminder.json").then((gapminder) => {

        // 1. Filtering our data to just 1955
        const year = 1955;
        const data = gapminder.filter(d => d.year === year);

        // 2. Setting up variables that describe our chart's space.
        const height = 400;
        const width = 500;;
        const margin = ({top: 10, right: 10, bottom: 20, left: 20});

        // 3. Create a SVG we will use to make our chart.
        // See https://developer.mozilla.org/en-US/docs/Web/SVG for more on SVGs.
        const svg = d3.create('svg')
          .attr('width', width)
          .attr('height', height);

        // 4. Setting up scales.
        const xScale = d3.scaleLinear()
          .domain([0, d3.max(gapminder, d => d.fertility)])
          .range([margin.left, width - margin.right])
          .nice();

        const yScale = d3.scaleLinear()
          .domain([0, d3.max(gapminder, d => d.life_expect)])
          .range([height - margin.bottom, margin.top])
          .nice();

        const colorScale = d3.scaleOrdinal()
          .domain(gapminder.map(d => d.cluster))
          .range(d3.schemeTableau10); // try other schemes, too!


        // 5. Drawing our points
        const symbol = d3.symbol();
        const g = svg.append('g')
          .classed('marks', true)

          // helper that tackles selection and cluster color in the absence of a selection
          function getClusterColor(datum) {
            if (datum.hasOwnProperty("selected") && !datum.selected) {
              return "lightgray";
            }
            return colorScale(datum.cluster);
          };

        //*********************************************************************
        // Draw our histogram
        const width_histo = 500,
              height_histo = 150,
              margin_histo = {top: 10, right: 0, bottom: 20, left: 150};

        const svg_histo = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_Histo = (data) => d3.rollups(
          data.filter(d => (d.year === year && (!d.hasOwnProperty('selected') || d.selected == true))),
          vals => d3.sum(vals, d => d.pop),
          d => d.cluster
        ).map(d => ({key: d[0], value: d[1]}));

        const rawAggregate = aggregate_Histo(gapminder);

        const xScale_Histo = d3.scaleLinear()
          .domain([0, d3.max(rawAggregate, d => d.value)])
          .range([margin_histo.left, width_histo - margin_histo.right])
          .nice();

        const yScale_Histo = d3.scaleBand()
          .domain(rawAggregate.map(d => d.key))
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .padding(0.1);

        svg_histo.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_Histo).ticks(3));

        const continents = ['South Asia',
          'Europe & Central Asia',
          'Sub-Saharan Africa',
          'America',
          'East Asia & Pacific',
          'Middle East & North Africa'];
          
        svg_histo.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_Histo).tickFormat((d,i) => continents[d]));

        const g_hist = svg_histo.append('g')
          .classed('marks', true);

        //histogram datajoin
        function dataJoinHisto(rawData = gapminder) {
          const data = aggregate_Histo(rawData);
          // console.log(data);

          g_hist.selectAll('rect')
            .data(data)
            // // join without animation:
            // .join('rect')
            //   .attr('x', margin_histo.left)
            //   .attr('y', d => yScale_Histo(d.key))
            //   .attr('width', d => xScale_Histo(d.value) - margin_histo.left)
            //   .attr('height', yScale_Histo.bandwidth())
            //   .style('fill', d => colorScale(d.key))
            // // To animate the changes instead:
            .join(
              enter => enter.append("rect")
                  .attr("fill", d => colorScale(d.key))
                  .attr('x', margin_histo.left)
                  .attr('y', d => yScale_Histo(d.key))
                  .attr('height', yScale_Histo.bandwidth())
                .call(enter => enter.transition().duration(1000)
                  .attr('width', d => xScale_Histo(d.value) - margin_histo.left)),
              update => update
                  .attr("fill", d => colorScale(d.key))
                  .attr('y', d => yScale_Histo(d.key))
                  // .attr('width', d => xScale_Histo(d.value) - margin_histo.left),
                .call(update => update.transition().duration(200)
                  .attr('width', d => xScale_Histo(d.value) - margin_histo.left)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => xScale_Histo(0) - margin_histo.left)
                  .remove())
            );

        }
        //*********************************************************************

        //scatter plot datajoin
        function dataJoin(rawData = gapminder) {
            const data = rawData.filter(d => d.year === year);

            g.selectAll('path')
                .data(data)
                .join('path')
                  .classed('country', true) // can reference these marks like css, i.e. 'path.country'
                  .attr('transform', d => `translate(${xScale(d.fertility)}, ${yScale(d.life_expect)})`)
                  .attr('fill', d => getClusterColor(d))
                  .attr('fill-opacity', 0.7)
                  .attr('d', d => symbol())
          }


        // Helper to draw both the scatter plot and the histogram
        function chartsDataJoin(rawData = gapminder) {
          dataJoin(rawData);

          // this is for the histogram
          dataJoinHisto(rawData);
        };

        chartsDataJoin();

        //6. Drawing our x-axis
        svg.append('g')
        .attr('transform', `translate(0, ${height - margin.bottom})`)
        .call(d3.axisBottom(xScale))
        // Add x-axis title 'text' element.
        .append('text')
          .attr('text-anchor', 'end')
          .attr('fill', 'black')
          .attr('font-size', '12px')
          .attr('font-weight', 'bold')
          .attr('x', width - margin.right)
          .attr('y', -10)
          .text('Fertility');

        //7. Drawing our y-axis
        svg.append('g')
          .attr('transform', `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(yScale))
          // Add y-axis title 'text' element.
          .append('text')
            .attr('transform', `translate(20, ${margin.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Life Expectancy');

        //8.  Adding a background label for the year.
        const yearLabel = svg.append('text')
          .attr('x', 40)
          .attr('y', height - margin.bottom - 20)
          .attr('fill', '#ccc')
          .attr('font-family', 'Helvetica Neue, Arial')
          .attr('font-weight', 500)
          .attr('font-size', 80)
          .text(year);

        // 9. Adding a brush to allow selecting a sub-region
        const brush = d3.brush()  // Add the brush feature using the d3.brush function
          // initialise the brush area
          .extent([[0, 0], [width, height]]) // wrong
          .extent([[margin.left, 0], [width, height-margin.bottom]])
          .on("start brush end", brushed)

        // 10. append element and call brush
        svg.select("g.marks")
            .attr("class", "brush")
            .call(brush)

        // 11. add brush callback to handle brush event
        function brushed(event) {
          const coords = event.selection; // [[x0, y0], [x1, y1]] for 2D brushes; [x0, x1] or [y0, y1] for 1D brushes
          if (coords) {
            const [[x0, y0], [x1, y1]] = coords;

            // augment the data with a field "selected" which is set to true only
            // for points within the brush selection
            const brushedData = gapminder.map(d => {
              return {
                ...d,
                selected: x0 <= xScale(d.fertility) && xScale(d.fertility) < x1 && y0 <= yScale(d.life_expect) && yScale(d.life_expect) < y1
              };
            });

            chartsDataJoin(brushedData);
          }
        };

        // 12. adding a clear on double click
        svg.on('dblclick', (event, d) => {
          // gapminder data is not augmented with the "selected" field above,
          // so getClusterColor knows to not grey things out
          chartsDataJoin(gapminder);
        });

        document.getElementById("chart").appendChild(svg.node());

        //add the histogram below the graph
        document.getElementById("chart").appendChild(svg_histo.node());

      });

      </script> -->

      <!-- Load main chart (this is after page has loaded) -->
      <script src="js/chart.js"></script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>
